<!DOCTYPE html>
<html lang="en">

	<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="author" content="Alessandro Versari">

    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>fibonhack | king exchange</title>

    <link rel="stylesheet" href="/assets/css/style.css">
    <script src="/assets/js/main.js"></script>

    <link rel="shortcut icon" href="/assets/images/favicon.png">

    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?..."></script>


    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M77YSCBXZY"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());

     gtag('config', 'G-M77YSCBXZY');
    </script>

</head>


		<body class="no-js bg-zinc-900 h-screen flex flex-col justify-between">

			<div>
    <nav class="w-full p-6 flex flex-col items-center justify-center my-3">

    <img class="w-2/5 md:w-1/4 lqip" data-src="/logo/transparent/800.png" src="/logo/transparent/100.png" alt="fibonhack"/>

    </nav>

    <nav class="md:py-6">
        <!-- whide screen navbar -->
        <div class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8">
          <div class="hidden sm:block relative flex h-16 items-center justify-between">
            <div class="flex flex-1 items-center justify-center sm:items-stretch sm:justify-center">
              <div class="sm:ml-6">
                <div class="flex space-x-4">

                  
                    <a href=/ class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Home</a>
                  
                    <a href=/resources class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Resources</a>
                  
                    <a href=/posts class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Posts</a>
                  
                    <a href=/writeups class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Writeups</a>
                  
                    <a href=/events class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Events</a>
                  
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- mobile navbar -->
        <div class="sm:hidden" id="mobile-menu">
          <div class="space-y-1 px-2 pt-2 pb-3">

            
              <a href=/
                
                class="border-b border-dashed border-1 border-zinc-600 text-white block px-3 py-2 text-lg  text-zinc-300 font-medium "
              >
                Home
              </a>
            
              <a href=/resources
                
                class="border-b border-dashed border-1 border-zinc-600 text-white block px-3 py-2 text-lg  text-zinc-300 font-medium "
              >
                Resources
              </a>
            
              <a href=/posts
                
                class="border-b border-dashed border-1 border-zinc-600 text-white block px-3 py-2 text-lg  text-zinc-300 font-medium "
              >
                Posts
              </a>
            
              <a href=/writeups
                
                class="border-b border-dashed border-1 border-zinc-600 text-white block px-3 py-2 text-lg  text-zinc-300 font-medium "
              >
                Writeups
              </a>
            
              <a href=/events
                
                class="border-b border-dashed border-1 border-zinc-600 text-white block px-3 py-2 text-lg  text-zinc-300 font-medium "
              >
                Events
              </a>
            
          </div>
        </div>
    </nav>
    <nav class="flex flex-wrap mx-auto w-full container md:px-0 px-4 text-white text-lg">
        <span class="text-green-500">fibonhack@templeos</span>
        <p>:</p>
        <span class="text-blue-400">~/king exchange</span>
        <p>$</p>
        <div class="ml-1 ">
            cat page.txt
        </div>
    </nav>

</div>

  	  
			<div class="
				 
				main
				prose prose-invert 
				!container w-full
				mb-auto px-4 mx-auto py-6
				text-zinc-300
				"
			>
				<div class="post">
  <article class="post-content">
  <div class="post">

  <header class="post-header" style="padding-bottom: 0.8em;">
    <p> 24 May 2020 </p>
    <h1 style="margin: -0.02em auto;"> king exchange - m0lecon 2020 Teaser - crypto</h1>
    <div id="authors"> by
    
    
      
      <a href="/members/trenta3">trenta3</a>
      
    
    
    </div>
  </header>

  <article class="post-content">
  <h2 id="initial-thoughts">Initial thoughts</h2>

<p>We were presented with the source code of <code class="language-plaintext highlighter-rouge">server.py</code>, which is the script used for encryption.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Other imports removed
</span><span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">flag</span><span class="p">,</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">add_points</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">%</span> <span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">add_points</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">add_points</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">//</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">Q</span>
</code></pre></div></div>

<p>As we can see it first defines an operation between points (written as tuples).
By seeing the operation to add points, and doing a little math, we recognize that the operation is the group operation on the conic \(X^2 + Y^2 = 1\).
Equivalently, the operation on the conic is complex multiplication when we encode the point \((x, y)\) as \(x + iy\), so we are effectively operating on gaussian integers.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">gen_key</span><span class="p">():</span>
    <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x43bf9535b2c484b67c68cb98bace14ae9526d955732e2e30ac0895ab6ba</span><span class="p">,</span> <span class="mh">0x4a9f13a6bd7bb39158cc785e05688d8138b05af9f1e13e01aaef7c0ab94</span><span class="p">)</span>
    <span class="n">sk</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="p">)</span>
    <span class="n">pk</span> <span class="o">=</span> <span class="n">multiply</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">sk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sk</span><span class="p">,</span> <span class="n">pk</span>

<span class="n">a</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">gen_key</span><span class="p">()</span>
<span class="n">b</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">gen_key</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>

<span class="n">shared</span> <span class="o">=</span> <span class="n">multiply</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">shared</span><span class="p">)).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
<span class="n">ciphertext</span> <span class="o">=</span> <span class="n">aes</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">flag</span><span class="p">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">.</span><span class="nb">hex</span><span class="p">())</span>
</code></pre></div></div>

<h2 id="plan-of-attack">Plan of attack</h2>

<p>We can then see that we are given a generator of the group, and a diffie-hellman exchange is done, but we are only provided the public keys. The flag is then encrypted using the secret.
So our goal is to break the encryption to recover the shared secret.</p>

<p>We first recover the prime modulus p which is needed for the calculations: we notice that A[0]**2 + A[1]**2 - 1, B[0]**2 + B[1]**2 - 1 and g[0]**2 + g[1]**2 - 1 are all divisible by the prime modulus, so that we take their gcd to get our possible candidate P, and check that it is prime by fourty rounds of miller-rabin primality test.</p>

<p>We notice that the prime \(p\) is congruent to three modulo four, which remains a prime also inside of gaussian integers (while prime \(\equiv 3 \ (\mod 4)\) do split).
Therefore \(\frac{\mathbb{Z}[i]}p\) is a field which is finite, so that it is isomorphic (as field) to \(\mathbb{F}_{p^2}\), therefore its multiplicative order is \(p^2 - 1\) (Interested readers can see <a href="https://kconrad.math.uconn.edu/blurbs/ugradnumthy/Zinotes.pdf">this reference</a>).</p>

<p>Factorizing the order, we notice that its greater factor is 480231246962542657532393144857, which is quite small, so we try to attack it via the chinese remainder theorem, which requires us to just solve the discrete logarithm problem inside subgroups.
After coding the small-steps giant-steps algorithm for the discrete logarithm, and trying not to loose our mind in the correct way to apply the chinese remainder theorem, we recovered the exponent of A, and obtained the shared key.</p>

<h2 id="putting-all-together">Putting all together</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x43bf9535b2c484b67c68cb98bace14ae9526d955732e2e30ac0895ab6ba</span><span class="p">,</span> <span class="mh">0x4a9f13a6bd7bb39158cc785e05688d8138b05af9f1e13e01aaef7c0ab94</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="mi">70584838528566138057920558091160583247156394376694509226477175997005624</span><span class="p">,</span> <span class="mi">47208562635669790449305203114934717034939475647594168392271311241505021</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28274152596231079767179933954556001021066477327209843622539706192176128</span><span class="p">,</span> <span class="mi">99565893173481261433550089673695177934890207483997197067732588009694082</span><span class="p">)</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"aaa21dce78ef99d23aaa70e5d263719de9245f33b8a9e2a0a63c8847dba61296c5a1f56154b062d3a347faa31b8d8030"</span>

<span class="c1"># The curve with that addition law is x^2 + y^2 = 1.
# Find plausible p's as divisors of g_1^2 + g^2 - 1.
</span><span class="n">bign</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">biga</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">bigb</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">hcfnaive</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="s">"Naively computes the GCD"</span>
    <span class="k">if</span><span class="p">(</span><span class="n">b</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hcfnaive</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="o">%</span><span class="n">b</span><span class="p">)</span> 

<span class="n">p</span> <span class="o">=</span> <span class="n">hcfnaive</span><span class="p">(</span><span class="n">bign</span><span class="p">,</span> <span class="n">biga</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">hcfnaive</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bigb</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Final P: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
<span class="kn">from</span> <span class="nn">factordb.factordb</span> <span class="kn">import</span> <span class="n">FactorDB</span>
<span class="k">def</span> <span class="nf">factors</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">FactorDB</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">f</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="n">get_factor_list</span><span class="p">()</span>

<span class="c1"># The right one is the biggest one, the others are too small to contain A and B
</span><span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Factors: </span><span class="si">{</span><span class="n">factors</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>
<span class="k">def</span> <span class="nf">miller_rabin</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">True</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">False</span>

	<span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
		<span class="n">x</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">True</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
				<span class="k">return</span> <span class="bp">True</span>
			<span class="n">x</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">x</span> <span class="o">==</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>

	<span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>

	<span class="k">while</span> <span class="n">d</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="n">d</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="mi">1</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
			<span class="k">return</span> <span class="bp">False</span>
	<span class="k">return</span> <span class="bp">True</span>

<span class="k">assert</span> <span class="n">miller_rabin</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">miller_rabin</span><span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">miller_rabin</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">p</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">3</span>
<span class="c1"># Therefore Z[i]/p is a field, and we know that its order is p**2 - 1, since it is
# isomorphic to F_{p^2}.
# See also https://kconrad.math.uconn.edu/blurbs/ugradnumthy/Zinotes.pdf
</span>
<span class="c1"># Now we decompose the order, and try to see if we can lower the difficulty of the problem.
</span>
<span class="k">def</span> <span class="nf">add_points</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">%</span> <span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">add_points</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">add_points</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">//</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">Q</span>

<span class="n">order_factors</span> <span class="o">=</span> <span class="n">factors</span><span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Factors: </span><span class="si">{</span><span class="n">order_factors</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">ghalf</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="k">assert</span> <span class="n">multiply</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">multiply</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">ghalf</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="k">def</span> <span class="nf">baby_steps_giant_steps</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">group_order</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Q</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">group_order</span><span class="p">))</span>

    <span class="n">baby_steps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">baby_step</span> <span class="o">=</span> <span class="n">Q</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">baby_steps</span><span class="p">[</span><span class="n">baby_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">baby_step</span> <span class="o">=</span> <span class="n">add_points</span><span class="p">(</span><span class="n">baby_step</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>

    <span class="n">H</span> <span class="o">=</span> <span class="n">multiply</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">giant_step</span> <span class="o">=</span> <span class="n">H</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">giant_step</span> <span class="ow">in</span> <span class="n">baby_steps</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">N</span> <span class="o">-</span> <span class="n">baby_steps</span><span class="p">[</span><span class="n">giant_step</span><span class="p">]</span>
        <span class="n">giant_step</span> <span class="o">=</span> <span class="n">add_points</span><span class="p">(</span><span class="n">giant_step</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">discrete_logarithm</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">group_order</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">baby_steps_giant_steps</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">group_order</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">group_order</span> <span class="o">&lt;=</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">naive</span> <span class="o">=</span> <span class="n">naive_discrete_logarithm</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">naive</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">naive</span> <span class="o">==</span> <span class="n">result</span>
        
<span class="k">def</span> <span class="nf">prime_powers</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="n">factors</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">dct</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">el</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>
            <span class="n">dct</span><span class="p">[</span><span class="n">el</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dct</span><span class="p">[</span><span class="n">el</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">el</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">miller_rabin</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dct</span>

<span class="kn">from</span> <span class="nn">sympy.ntheory.modular</span> <span class="kn">import</span> <span class="n">crt</span>

<span class="c1"># Get exponent of A in group generate by G which is of order n
</span><span class="k">def</span> <span class="nf">get_exponent_of</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">expon</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">powers</span> <span class="o">=</span> <span class="n">prime_powers</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">prime</span><span class="p">,</span> <span class="n">power</span> <span class="ow">in</span> <span class="n">powers</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># print(f"Processing {prime}^{power}")
</span>        <span class="n">expon</span><span class="p">[</span><span class="n">prime</span><span class="o">**</span><span class="n">power</span><span class="p">]</span> <span class="o">=</span> <span class="n">discrete_logarithm</span><span class="p">(</span><span class="n">multiply</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">n</span> <span class="o">//</span> <span class="p">(</span><span class="n">prime</span> <span class="o">**</span> <span class="n">power</span><span class="p">)),</span> <span class="n">multiply</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">n</span> <span class="o">//</span> <span class="p">(</span><span class="n">prime</span> <span class="o">**</span> <span class="n">power</span><span class="p">)),</span> <span class="n">prime</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>
        <span class="c1"># print(f"Expon: {expon[prime**power]}")
</span>    <span class="n">moduli</span> <span class="o">=</span> <span class="p">[</span><span class="n">prime_power</span> <span class="k">for</span> <span class="n">prime_power</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">expon</span><span class="p">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">order_pp</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">order_pp</span> <span class="ow">in</span> <span class="n">expon</span><span class="p">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">crt</span><span class="p">(</span><span class="n">moduli</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Just one is needed, but we double check everything
</span><span class="n">exponA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">get_exponent_of</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"exponA: </span><span class="si">{</span><span class="n">exponA</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">multiply</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">exponA</span><span class="p">)</span> <span class="o">==</span> <span class="n">A</span>

<span class="n">exponB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">get_exponent_of</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"exponB: </span><span class="si">{</span><span class="n">exponB</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">multiply</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">exponB</span><span class="p">)</span> <span class="o">==</span> <span class="n">B</span>

<span class="n">sharedB</span> <span class="o">=</span> <span class="n">multiply</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">exponA</span><span class="p">)</span>
<span class="n">sharedA</span> <span class="o">=</span> <span class="n">multiply</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">exponB</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">sharedA</span> <span class="o">==</span> <span class="n">sharedB</span>
<span class="n">shared</span> <span class="o">=</span> <span class="n">sharedA</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Shared: </span><span class="si">{</span><span class="n">shared</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">shared</span><span class="p">)).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">unhexlify</span>
<span class="n">cleantext</span> <span class="o">=</span> <span class="n">aes</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">cipher</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Flag: </span><span class="si">{</span><span class="n">cleantext</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

  </article>
</div>

  </article>

</div>

			</div>

	<nav class="
     
    flex flex-wrap mx-auto w-full md:px-0 px-4 text-white text-lg mb-6 
    container
    terminal
    "
>
    <span class="text-green-500">fibonhack@templeos</span>
    <p>:</p>
    <span class="text-blue-400">~/king exchange</span>
    <p>$</p>
    <form class="terminal_form flex ml-1 relative">
        <input type="text" spellcheck="false" class="border-transparent focus:border-transparent focus:ring-0 w-full bg-transparent focus:outline-0 border-none">
    </form>
</nav>

<footer class="
         
        space-y-6 md:space-y-0 flex flex-col md:flex-row text-white justify-between 
        w-full py-12 px-6 space-y-6 border-t border-dashed border-1 border-zinc-600 items-center
    "
>

    <div class="flex-1 items-center">
        theme developed by <a class="underline" href="https://github.com/just-hms/">just-hms</a> 
    </div>

    <div class="space-x-4 flex items-center justify-center">
        <a class="text-zinc-600 hover:text-zinc-100" href="https://github.com/fibonhack">
            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
</svg>
        </a>
    
        <a class="text-zinc-600 hover:text-blue-400" href="https://twitter.com/fibonhack">
            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
    <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/>
</svg>
            
        </a>
    
        <a class="saturate-0 contrast-[.75] brightness-[.75] hover:brightness-100 hover:contrast-100 hover:saturate-[.40]" href="https://ctftime.org/team/117538">
            <svg class="w-auto h-8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 283.46 79.33" style="enable-background:new 0 0 283.46 79.33;" xml:space="preserve">
	<style type="text/css">
		.st0{fill:#E3000B;}
		.st1{fill:#FFFFFF;}
	</style>
	<g id="Layer_1">
		<polygon class="st0" points="0,79.52 154.36,79.52 283.46,79.52 283.46,0.19 0,0.19 33.23,40.29  "/>
		<polygon class="st1" points="61.92,57.92 80.47,57.92 80.47,51.68 74.06,51.68 74.06,51.68 69.3,51.68 69.3,27.9 74.06,27.9    74.06,27.9 80.47,27.9 80.47,21.02 61.92,21.02  "/>
		<polygon class="st1" points="86.32,28.11 91.6,28.11 91.6,57.92 98.98,57.92 98.98,28.11 104.25,28.11 104.25,21.02 86.32,21.02     "/>
		<polygon class="st1" points="110.3,57.63 117.69,57.63 117.69,42.88 126.9,42.88 126.9,37.15 117.69,37.15 117.69,27.9    129.02,27.9 129.02,21.02 110.3,20.73  "/>
		<polygon class="st1" points="182.79,25.34 188.33,25.34 188.33,57.92 192.76,57.92 192.76,25.34 198.29,25.34 198.29,21.02    182.79,21.02  "/>
		<rect x="203.31" y="21.02" class="st1" width="4.43" height="36.9"/>
		<polygon class="st1" points="224.16,34.52 218.89,21.02 214.52,21.02 214.52,57.92 218.89,57.92 218.89,31.78 224.16,45.06    229.43,31.78 229.43,57.92 233.81,57.92 233.81,21.02 229.43,21.02  "/>
		<polygon class="st1" points="244.77,53.6 244.77,41.58 252.15,41.58 252.15,37.26 244.77,37.26 244.77,25.34 256.88,25.34    258.04,21.02 240.34,21.02 240.34,57.92 257.85,57.92 256.69,53.6  "/>
		<path class="st1" d="M135.54,21.02v36.9h39.7v-36.9H135.54z M169.83,52.89h-28.87V26.05h28.87V52.89z"/>
		<polygon class="st1" points="153.91,39.38 147.8,45.48 151.83,49.05 161.24,39.65 145.16,23.57 138.1,23.57  "/>
	</g>
</svg>
        </a>
    </div>
    
</footer>

	</body>
</html>
