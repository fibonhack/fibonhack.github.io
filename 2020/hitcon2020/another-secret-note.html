<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>fibonhack | another secret note</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/assets/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/main.css">


    <link rel="shortcut icon" href="/assets/images/favicon.jpg">
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-167636907-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-167636907-1');
    </script>

</head>


    <body>
      <div class="container">

        <header class="row">
    <div class="col-lg-8 col-lg-offset-2">
        <img class="main-logo" src="/assets/images/fibonhack.png" alt="fibonhack">
    </div>
</header>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu glow-yellow">
      <ul>
          <li><a href="/" >home</a></li>
          <li><a href="/resources" >resources</a></li>
          <li><a href="/posts" >posts</a></li>
          <li><a href="/writeups" >writeups</a></li>
        </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">
  <article class="post-content">
  <div class="post">

  <header class="post-header" style="padding-bottom: 0.8em;">
    <p> 2 Dec 2020 </p>
    <h1 style="margin: -0.02em auto;"> another secret note - hitcon 2020 - crypto</h1>
    <div id="authors"> by
    
    
      
      <a href="/members/marcog">marcog</a>
      
    
    
    </div>
  </header>

  <article class="post-content">
  <p>We are given a python script that represent a remote server:</p>

<p>\(prob.py\)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">import</span> <span class="nn">base64</span><span class="p">,</span><span class="n">random</span><span class="p">,</span><span class="n">hashlib</span><span class="p">,</span><span class="n">json</span><span class="p">,</span><span class="n">string</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">MyRandom</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">.</span><span class="n">mask</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">magic</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">.</span><span class="n">mask</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">.</span><span class="n">mask</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">))</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">.</span><span class="n">mask</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span>


<span class="k">def</span> <span class="nf">get_random</span><span class="p">(</span><span class="n">my_random</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">//=</span> <span class="mi">4</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">my_random</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span><span class="p">)]</span>
    <span class="n">byte_lst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
        <span class="n">byte_lst</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="o">%</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">byte_lst</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">%</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">byte_lst</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">%</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">byte_lst</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">)</span><span class="o">%</span><span class="mi">256</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">byte_lst</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">pad_len</span> <span class="o">=</span> <span class="mi">16</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">%</span><span class="mi">16</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="n">pad_len</span><span class="p">)</span><span class="o">*</span><span class="n">pad_len</span>

<span class="k">def</span> <span class="nf">unpad</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="n">v</span><span class="p">:]</span> <span class="o">==</span> <span class="nb">chr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="n">v</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">proof_of_work</span><span class="p">():</span>
    <span class="n">proof</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="n">ascii_letters</span><span class="o">+</span><span class="n">string</span><span class="p">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">proof</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"SHA256(XXXX+%s) == %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">proof</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span><span class="n">digest</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">'Give me XXXX:'</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">!=</span><span class="mi">4</span> <span class="ow">or</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">((</span><span class="n">x</span><span class="o">+</span><span class="n">proof</span><span class="p">[</span><span class="mi">4</span><span class="p">:]).</span><span class="n">encode</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">!=</span> <span class="n">digest</span><span class="p">:</span> 
        <span class="nb">exit</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'key'</span><span class="p">,</span><span class="s">'rb'</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">user_secret</span><span class="o">+</span><span class="n">admin_secret</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">flag</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'hitcon{'</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">flag</span><span class="p">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'}'</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_secret</span><span class="p">)</span><span class="o">==</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">admin_secret</span><span class="p">)</span><span class="o">==</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">proof_of_work</span><span class="p">()</span>
    <span class="n">my_random</span> <span class="o">=</span> <span class="n">MyRandom</span><span class="p">()</span>
    <span class="n">iv</span> <span class="o">=</span>  <span class="n">get_random</span><span class="p">(</span><span class="n">my_random</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">note</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"cmd: "</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="s">"register"</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"name: "</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">'admin'</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">'no! I dont believe that'</span><span class="p">)</span>
                    <span class="nb">exit</span><span class="p">()</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'secret'</span><span class="p">:</span> <span class="n">user_secret</span><span class="p">,</span> <span class="s">'who'</span><span class="p">:</span> <span class="s">'user'</span><span class="p">,</span> <span class="s">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
                <span class="n">encrypted</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">string</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="nb">hex</span><span class="p">()</span>
                <span class="n">send_data</span> <span class="o">=</span> <span class="p">{</span><span class="s">"cipher"</span><span class="p">:</span> <span class="n">encrypted</span><span class="p">}</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"token: "</span><span class="p">,</span><span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">send_data</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">decode</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">msg</span> <span class="o">==</span> <span class="s">"login"</span><span class="p">:</span>
                <span class="n">recv_data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">"token: "</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">decode</span><span class="p">())</span>
                <span class="k">if</span> <span class="s">'iv'</span> <span class="ow">in</span> <span class="n">recv_data</span><span class="p">:</span>
                    <span class="n">iv</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">recv_data</span><span class="p">[</span><span class="s">'iv'</span><span class="p">])</span>
                <span class="n">encrypted</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">recv_data</span><span class="p">[</span><span class="s">'cipher'</span><span class="p">])</span>
                <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">).</span><span class="n">decode</span><span class="p">())</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">'cmd'</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">'cmd'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'get_secret'</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s">"who"</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="s">"who"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"admin"</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="s">'admin'</span><span class="p">:</span>
                            <span class="n">data</span><span class="p">[</span><span class="s">"secret"</span><span class="p">]</span> <span class="o">=</span> <span class="n">admin_secret</span>
                    <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="s">'cmd'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'get_time'</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="s">'time'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="s">'cmd'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'note'</span><span class="p">:</span>
                        <span class="n">note_name</span> <span class="o">=</span> <span class="n">get_random</span><span class="p">(</span><span class="n">my_random</span><span class="p">,</span> <span class="mi">4</span><span class="p">).</span><span class="nb">hex</span><span class="p">()</span> 
                        <span class="n">note</span><span class="p">[</span><span class="n">note_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'note'</span><span class="p">]</span>
                        <span class="n">data</span><span class="p">[</span><span class="s">'note_name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_name</span>
                    <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="s">'cmd'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'read_note'</span><span class="p">:</span>
                        <span class="n">note_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'note_name'</span><span class="p">]</span> 
                        <span class="n">data</span><span class="p">[</span><span class="s">'note'</span><span class="p">]</span> <span class="o">=</span> <span class="n">note</span><span class="p">[</span><span class="n">note_name</span><span class="p">]</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
                <span class="n">encrypted</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">string</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="nb">hex</span><span class="p">()</span>
                <span class="n">send_data</span> <span class="o">=</span> <span class="p">{</span><span class="s">"cipher"</span><span class="p">:</span> <span class="n">encrypted</span><span class="p">}</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"token: "</span><span class="p">,</span><span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">send_data</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>

<p>Essentially we have the flag 32 byte long, divided in 2 parts \(user\_secret\) and \(admin\_secret\), and 2 function \(register\) and \(login\).</p>

<p>In \(register\) we can ask to encrypt a json that contains our username in the format:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"secret"</span><span class="p">:</span> <span class="n">user_secret</span><span class="p">,</span> <span class="s">"who"</span><span class="p">:</span> <span class="s">"user"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">:</span> <span class="n">user</span><span class="p">}</span>
</code></pre></div></div>
<p>This json is encrypted and encoded in base64 and inserted inside a json:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"cipher"</span><span class="p">:</span> <span class="n">encrypted</span><span class="p">}</span>
</code></pre></div></div>
<p>Inside \(login\) we can input a json in the same format as above and we can also input a IV for the decryption of the ciphertext.</p>

<p>The objective of this challenge is to recover the two half of the flag, is possible to recover the first half with an oracle attack on the decryption (more on the next part), instead, the second part is recoverable only sending a ciphertext to the login function with a json:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"secret"</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span> <span class="s">"cmd"</span><span class="p">:</span> <span class="s">"get_secret"</span><span class="p">,</span> <span class="s">"who"</span><span class="p">:</span> <span class="s">"admin"</span><span class="p">,</span> <span class="s">"user"</span><span class="p">:</span> <span class="s">"admin"</span><span class="p">}</span>
</code></pre></div></div>
<p>Then the returned ciphertext contains the \(admin\_secret\) in the first 3 block.</p>

<p>The encryption/decryption is done using AES-CBC with a random IV and the same key every session.</p>

<p>When decrypting the \(login\) function check if the decrypted plaintext is padded correctly and then it load the the string into a json. If an exception is thrown the program terminate. Now, the second block of the ciphertext after the \(login\) is always the encryption of:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>on{123456789", "
</code></pre></div></div>
<p>Xorred with the first block of the ciphertext. 123456789 are the last 9 characters of the user secret (as the flag start with <code class="language-plaintext highlighter-rouge">hitcon{</code> and terminate with <code class="language-plaintext highlighter-rouge">}</code>). So we can input as IV the first block of ciphertext and the second block alone as ciphertext. The decryption should get the original plaintext incorrecly padded as it terminate with “ and the json should throw an exception.</p>

<p><img style="background-color:white" src="/assets/files/CBC_decryption.png" alt="AES CBC" /></p>

<p>Using this schema we can calculate the new IV to use to obtain a target text knowing the original plaintext: (\(P\) is the old plaintext and \(T\) is the target plaintext after the decryption)</p>

\[NEWIV_i = IV_i \oplus P_i \oplus T_i\]

<p>This because the first make the decryption all zeros, instead the second make the result equals to the target \(T\). Not knowing the original plaintext we can try to decode 1 character at a time. We start by trying to obtain the target \(T\):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">'{ "12345678":3}'</span><span class="o">+</span><span class="s">'</span><span class="se">\x01</span><span class="s">'</span>
</code></pre></div></div>
<p>So that the unpadding pass and is a correct json string. To do that we need to know the ninth unknown character of the flag, but we can try all the possible printable character to recover that. Next whe can continue to decode the plaintext by guessing the eight character as <code class="language-plaintext highlighter-rouge">'{ "1234567" :3}'+'\x01'</code> etc…</p>

<p>Possible Script for the first part:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">do_pow</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">LOCAL</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"SHA256(XXXX+"</span><span class="p">)</span>
    <span class="n">first</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">") == "</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">digest</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="n">ascii_letters</span><span class="o">+</span><span class="n">string</span><span class="p">.</span><span class="n">digits</span><span class="p">,</span><span class="n">repeat</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">combo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">((</span><span class="n">x</span><span class="o">+</span><span class="n">first</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="n">digest</span><span class="p">:</span> 
            <span class="k">print</span><span class="p">(</span><span class="s">"found"</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Give me XXXX:"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">change</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">orig</span><span class="p">,</span><span class="n">result</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">orig</span><span class="p">,</span><span class="n">result</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">v</span><span class="o">^</span><span class="nb">ord</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">^</span><span class="nb">ord</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">ret</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

<span class="n">do_pow</span><span class="p">()</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"cmd: "</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"register"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"name: "</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"user12345"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">LOCAL</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"}"</span><span class="p">).</span><span class="n">decode</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"token: "</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="n">decode</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="n">iv</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="s">"cipher"</span><span class="p">][:</span><span class="mi">32</span><span class="p">])</span>

<span class="n">dup</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">elements</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">digits</span><span class="o">+</span><span class="s">"_-"</span><span class="o">+</span><span class="n">string</span><span class="p">.</span><span class="n">ascii_letters</span>
<span class="n">key</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)):</span>
    <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">io</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>
            <span class="n">do_pow</span><span class="p">()</span>
            <span class="n">cut</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">ivchange</span> <span class="o">=</span> <span class="n">change</span><span class="p">(</span><span class="n">iv</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="s">'on{'</span> <span class="p">,</span><span class="s">'{ "'</span><span class="p">)</span><span class="o">+</span><span class="n">iv</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">cut</span><span class="p">]</span><span class="o">+</span><span class="n">change</span><span class="p">(</span><span class="n">iv</span><span class="p">[</span><span class="n">cut</span><span class="p">:],</span> <span class="n">c</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s">'", "'</span> <span class="p">,</span>    <span class="s">'"'</span><span class="o">+</span><span class="s">' '</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="s">':3}'</span><span class="o">+</span><span class="s">"</span><span class="se">\x01</span><span class="s">"</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dup</span><span class="p">[</span><span class="s">"iv"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivchange</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span>
            <span class="n">dup</span><span class="p">[</span><span class="s">"cipher"</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s">"cipher"</span><span class="p">][</span><span class="mi">32</span><span class="p">:</span><span class="mi">64</span><span class="p">]</span>
            <span class="n">send_data</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dup</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">decode</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="n">dup</span><span class="p">)</span>
            <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"login"</span><span class="p">)</span>
            <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"token: "</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"send %s"</span><span class="o">%</span><span class="n">c</span><span class="p">)</span>
            <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">send_data</span><span class="p">)</span>
            <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"cmd:"</span><span class="p">)</span>
            <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"ERROR"</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">c</span><span class="o">+</span><span class="n">key</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div></div>

<p>At the end (after many minutes as every guess need a new connection and a new PoW) we obtain <code class="language-plaintext highlighter-rouge">hitcon{JSON_is_5</code>.</p>

<p>To continue the challenge I found an unintended way, unintended because it does not use the random number generator, nor the note commands.</p>

<p>If we need to make the \(login\) function decrypt more blocks than 1 we can try to first set the second block as we want and use the old schema to make it decrypt as we want, changing the first ciphertext block instead of the \(IV\). The problem now is that we do not know the plaintext of the first block to set the \(IV\) correctly to decrypt to the target plaintext as we generated it to match what we wanted. Obviously this does not work.</p>

<p>Instead, to make it work, we can change our schema as follows:
<img src="/assets/files/CBC-schema2.png" alt="CBC Schema" /></p>

<p>In Red the first block is xorred with the plain text to obtain the intermediate state in green. When decrypting the immediate state in green is xorred with the \(IV\) in black obtaining the target plain text in yellow. If we find (using the \(register\) function to generate long usernames) two blocks (red and black) such that \(P1_i = T1_i \oplus C0_i \oplus \overline{C0}_i\) (where \(T\) is the target plaintext, \(\overline{C0}\) and \(C0\) are the two blocks) and \(P_i\) are all printable characters inside a json string (only printable characters and no “ and other escaped characters).
We can obtain the plaintext necessary for obtaining the target plaintext \(T1\) by passing to the \(regiter\) function the same string to generate \(\overline{C0}\) and another block \(P1\) obtained before. The result of the encryption contains the ciphtertext in pink (let’s call it \(C1\)) of such block that passed to the \(login\) function as second block, as first block  \(C0\) found before and as IV the necessary IV to decrypt the first block as \(T0\). As the plaintext of every block is known we can do that. Obviously we need a correct padding and correct json string as target.</p>

<p>To continue concatenating block we can search for another ciphertext \(\overline{C1}\) that satisfy the previous condition: \(P2_i = T2_i \oplus \overline{C1}_i \oplus C1_i\) and \(P2\) is printable and json escaped as before. Now we can generate the ciphertext \(C2\) relative to \(P2\) by using the same string inside the \(register\) and appending \(P2\) after the plaintext of \(\overline{C1}\). After that we have now 3 blocks that we can use to generate whatever string we want inside the json, we can continue and search for a forth block by searching \(\overline{C2}\) such that \(P3_i = T2_i \oplus \overline{C2}_i \oplus C2_i\) and \(P3\) is printable and json escaped etc…</p>

<p>If you are worried about how much time is needed to find a match do not worry, the first match is found in less than 5 seconds, the next ones in less than a minute, so is very fast, just use username of 10000 blocks of 16 characters :)</p>

<p>Now we can put inside the ciphertext the json:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"secret"</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span> <span class="s">"cmd"</span><span class="p">:</span> <span class="s">"get_secret"</span><span class="p">,</span> <span class="s">"who"</span><span class="p">:</span> <span class="s">"admin"</span><span class="p">,</span> <span class="s">"user"</span><span class="p">:</span> <span class="s">"admin"</span><span class="p">}</span>
</code></pre></div></div>
<p>This request would return the \(admin\_secret\) inside the first 2 blocks of the ciphertext returned:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"secret"</span><span class="p">:</span> <span class="s">"123456789012345}"</span><span class="p">,</span> <span class="s">"cmd"</span><span class="p">:</span> <span class="s">"get_secret"</span><span class="p">,</span> <span class="s">"who"</span><span class="p">:</span> <span class="s">"admin"</span><span class="p">,</span> <span class="s">"user"</span><span class="p">:</span> <span class="s">"admin"</span><span class="p">}</span>
</code></pre></div></div>
<p>We can recover with first method by guessing a character at a time from the end. Starting from the 15th character:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">'{"secret": "12345678901234"  }'</span><span class="o">+</span><span class="s">'</span><span class="se">\x02\x02</span><span class="s">'</span>
</code></pre></div></div>
<p>and continuing by guessing the 14th…</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">'{"secret": "1234567890123"   }'</span><span class="o">+</span><span class="s">'</span><span class="se">\x02\x02</span><span class="s">'</span>
</code></pre></div></div>

  </article>
</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
    <div class="col-lg-8 col-lg-offset-2">
        <footer>
            <div>
                <div class="footer left column one-half">
                    <small class="glow-yellow">
                        Theme <a href="https://github.com/gildasio/clyell"> clyell</a> by <a
                            href="https://github.com/gildasio/">gildasio</a> <br class="hidden visible-xs">powered by <a
                            href="https://github.com/jekyll/jekyll">{{ jekyll }}</a>
                    </small>
                </div>

                <div class="footer right column one-half">
                    <section class="small-font">
                        <a href="https://twitter.com/fibonhack"><span class="icon icon--twitter">
    <svg viewBox="0 0 16 16">
        <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
    </svg>
</span>
</a>
                        <a href="https://github.com/fibonhack"><span class="icon icon--github">
    <svg viewBox="0 0 16 16">
        <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
    </svg>
</span>
</a>
                    </section>
                </div>
            </div>
        </footer>
    </div>
</div>

      </div>
    </body>
</html>
